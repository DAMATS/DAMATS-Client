var namespace=function(c,b,a){c=c.split(b||".");a=a||window;var d;b=0;for(d=c.length;b<d;b++)a=a[c[b]]=a[c[b]]||{};return a};namespace("WCS.Core");
WCS.Util=function(){return{objectToKVP:function(c){var b=[],a;for(a in c)b.push(a+"="+c[a]);return b.join("&")},stringToIntArray:function(c,b){return WCS.Util.map(c.split(b||" "),function(a){return parseInt(a)})},stringToFloatArray:function(c,b){return WCS.Util.map(c.split(b||" "),function(a){return parseFloat(a)})},getFirst:function(c,b,a){return!a?c:b?c.getElementsByTagNameNS(b,a)[0]:c.getElementsByTagName(a)[0]},getText:function(c,b,a,d){return(c=WCS.Util.getFirst(c,b,a))?c.textContent:d},getAll:function(c,
b,a){return!a?[c]:b?c.getElementsByTagNameNS(b,a):c.getElementsByTagName(a)},getTextArray:function(c,b,a){var d=[];c=WCS.Util.getAll(c,b,a);for(b=0;b<c.length;++b)d.push(c[b].textContent);return d},map:function(c,b){for(var a=[],d=0;d<c.length;++d)a.push(b(c[d]));return a},deepMerge:function(c,b){if(!("object"!=typeof c||"object"!=typeof b))for(var a in b)c.hasOwnProperty(a)&&"object"==typeof c[a]&&"object"==typeof b[a]?WCS.Util.deepMerge(c[a],b[a]):c[a]=b[a]}}}();
WCS.Core.KVP=function(){return{getCapabilitiesURL:function(c,b,a){if(!c)throw Error("Parameter 'url' is mandatory.");b=b||{};a=a||{};var d=["service=wcs","version=2.0.0","request=getcapabilities"];b.updatesequence&&d.push("updatesequence="+b.updatesequence);b.sections&&d.push("sections="+b.sections.join(","));b=WCS.Util.objectToKVP(a);return c+("?"!==c.charAt(c.length-1)?"?":"")+d.join("&")+(0<b.length?"&"+b:"")},describeCoverageURL:function(c,b,a){if(!c||!b)throw Error("Parameters 'url' and 'coverageids' are mandatory.");
var d=["service=wcs","version=2.0.0","request=describecoverage"];a=a||{};d.push("coverageid="+("string"===typeof b?b:b.join(",")));b=WCS.Util.objectToKVP(a);return c+("?"!==c.charAt(c.length-1)?"?":"")+d.join("&")+(0<b.length?"&"+b:"")},getCoverageURL:function(c,b,a,d){if(!c||!b)throw Error("Parameters 'url' and 'coverageid' are mandatory.");a=a||{};subsetCRS=a.subsetCRS||"http://www.opengis.net/def/crs/EPSG/0/4326";"?"!==c.charAt(c.length-1)&&(c+="?");b=["service=wcs","version=2.0.0","request=getcoverage",
"coverageid="+b];a.format&&b.push("format="+a.format);a.bbox&&(!a.subsetX&&!a.subsetY)&&(a.subsetX=[a.bbox[0],a.bbox[2]],a.subsetY=[a.bbox[1],a.bbox[3]]);a.subsetX&&b.push("subset=x,"+subsetCRS+"("+a.subsetX[0]+","+a.subsetX[1]+")");a.subsetY&&b.push("subset=y,"+subsetCRS+"("+a.subsetY[0]+","+a.subsetY[1]+")");a.size&&(!a.sizeX&&!a.sizeY)&&(a.sizeX=a.size[0],a.sizeY=a.size[1]);a.sizeX&&b.push("size=x("+a.sizeX+")");a.sizeY&&b.push("size=y("+a.sizeY+")");a.resolution&&(!a.resolutionX&&!a.resolutionY)&&
(a.resolutionX=a.resolution[0],a.resolutionY=a.resolution[1]);a.rangeSubset&&b.push("rangesubset="+a.rangeSubset.join(","));a.resolutionX&&b.push("resolution=x("+a.resolutionX+")");a.resolutionY&&b.push("resolution=y("+a.resolutionY+")");a.interpolation&&b.push("interpolation="+a.interpolation);a.outputCRS&&b.push("outputcrs="+a.outputCRS);a.multipart&&b.push("mediatype=multipart/mixed");a=WCS.Util.objectToKVP(d);return c+("?"!==c.charAt(c.length-1)?"?":"")+b.join("&")+(0<a.length?"&"+a:"")}}}();
WCS.Core.Parse=function(){var c;"undefined"!=typeof window.DOMParser?c=function(a){return(new window.DOMParser).parseFromString(a,"text/xml")}:"undefined"!=typeof window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")&&(c=function(a){var b=new window.ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a);return b});var b={},a=function(a,c){b.hasOwnProperty(a)?b[a].push(c):b[a]=[c]},d=function(b){for(var c in b)a(c,b[c])},g={throwOnException:!1},f=WCS.Util.getFirst,e=WCS.Util.getText,
k=WCS.Util.getAll,l=WCS.Util.getTextArray,m=WCS.Util.map,p=function(a){for(var b=f(a,"http://www.opengis.net/gml/3.2","Envelope"),c=f(a,"http://www.opengis.net/gml/3.2","domainSet"),g=WCS.Util.stringToIntArray(e(c,"http://www.opengis.net/gml/3.2","low")),d=WCS.Util.stringToIntArray(e(c,"http://www.opengis.net/gml/3.2","high")),h=[],j=0;j<Math.min(g.length,d.length);++j)h.push(d[j]+1-g[j]);for(var n=m(k(c,"http://www.opengis.net/gml/3.2","offsetVector"),function(a){return WCS.Util.stringToFloatArray(e(a))}),
p=[],j=0;j<n.length;++j)for(var q=0;q<n.length;++q)0!=n[q][j]&&p.push(n[q][j]);return{coverageId:e(a,"http://www.opengis.net/wcs/2.0","CoverageId"),dimensions:parseInt(f(a,"http://www.opengis.net/gml/3.2","RectifiedGrid").getAttribute("dimension")),bounds:{projection:b.getAttribute("srsName"),lower:WCS.Util.stringToFloatArray(e(b,"http://www.opengis.net/gml/3.2","lowerCorner")),upper:WCS.Util.stringToFloatArray(e(b,"http://www.opengis.net/gml/3.2","upperCorner"))},envelope:{low:g,high:d},size:h,origin:WCS.Util.stringToFloatArray(e(c,
"http://www.opengis.net/gml/3.2","pos")),offsetVectors:n,resolution:p,rangeType:m(k(a,"http://www.opengis.net/swe/2.0","field"),function(a){return{name:a.getAttribute("name"),description:e(a,"http://www.opengis.net/swe/2.0","description"),uom:f(a,"http://www.opengis.net/swe/2.0","uom").getAttribute("code"),nilValues:m(k(a,"http://www.opengis.net/swe/2.0","nilValue"),function(a){return{value:parseInt(a.textContent),reason:a.getAttribute("reason")}}),allowedValues:WCS.Util.stringToIntArray(e(a,"http://www.opengis.net/swe/2.0",
"interval")),significantFigures:parseInt(e(a,"http://www.opengis.net/swe/2.0","significantFigures"))}}),coverageSubtype:e(a,"http://www.opengis.net/wcs/2.0","CoverageSubtype"),supportedCRSs:l(a,"http://www.opengis.net/wcs/2.0","supportedCRS"),nativeCRS:e(a,"http://www.opengis.net/wcs/2.0","nativeCRS"),supportedFormats:l(a,"http://www.opengis.net/wcs/2.0","supportedFormat")}};d({Capabilities:function(a){var b=f(a,"http://www.opengis.net/ows/2.0","ServiceIdentification"),c=f(a,"http://www.opengis.net/ows/2.0",
"ServiceProvider"),g=f(a,"http://www.opengis.net/wcs/2.0","ServiceMetadata"),d=f(c,"http://www.opengis.net/ows/2.0","Phone"),h=f(c,"http://www.opengis.net/ows/2.0","Address");return{serviceIdentification:{title:e(b,"http://www.opengis.net/ows/2.0","Title"),"abstract":e(b,"http://www.opengis.net/ows/2.0","Abstract"),keywords:l(b,"http://www.opengis.net/ows/2.0","Keyword"),serviceType:e(b,"http://www.opengis.net/ows/2.0","ServiceType"),serviceTypeVersion:e(b,"http://www.opengis.net/ows/2.0","ServiceTypeVersion"),
profiles:l(b,"http://www.opengis.net/ows/2.0","Profile"),fees:e(b,"http://www.opengis.net/ows/2.0","Fees"),accessConstraints:e(b,"http://www.opengis.net/ows/2.0","AccessConstraints")},serviceProvider:{providerName:e(c,"http://www.opengis.net/ows/2.0","ProviderName"),providerSite:f(c,"http://www.opengis.net/ows/2.0","ProviderSite").getAttributeNS("http://www.w3.org/1999/xlink","href"),individualName:e(c,"http://www.opengis.net/ows/2.0","IndividualName"),positionName:e(c,"http://www.opengis.net/ows/2.0",
"PositionName"),contactInfo:{phone:{voice:e(d,"http://www.opengis.net/ows/2.0","Voice"),facsimile:e(d,"http://www.opengis.net/ows/2.0","Facsimile")},address:{deliveryPoint:e(h,"http://www.opengis.net/ows/2.0","DeliveryPoint"),city:e(h,"http://www.opengis.net/ows/2.0","City"),administrativeArea:e(h,"http://www.opengis.net/ows/2.0","AdministrativeArea"),postalCode:e(h,"http://www.opengis.net/ows/2.0","PostalCode"),country:e(h,"http://www.opengis.net/ows/2.0","Country"),electronicMailAddress:e(h,"http://www.opengis.net/ows/2.0",
"ElectronicMailAddress")},onlineResource:f(c,"http://www.opengis.net/ows/2.0","OnlineResource").getAttributeNS("http://www.w3.org/1999/xlink","href"),hoursOfService:e(c,"http://www.opengis.net/ows/2.0","HoursOfService"),contactInstructions:e(c,"http://www.opengis.net/ows/2.0","ContactInstructions")},role:e(c,"http://www.opengis.net/ows/2.0","Role")},serviceMetadata:{formatsSupported:l(g,"http://www.opengis.net/wcs/2.0","formatSupported"),crssSupported:l(g,"http://www.opengis.net/wcs/service-extension/crs/1.0",
"crsSupported")},operations:m(k(a,"http://www.opengis.net/ows/2.0","Operation"),function(a){return{name:a.getAttribute("name"),getUrl:f(a,"http://www.opengis.net/ows/2.0","Post").getAttributeNS("http://www.w3.org/1999/xlink","href"),postUrl:f(a,"http://www.opengis.net/ows/2.0","Get").getAttributeNS("http://www.w3.org/1999/xlink","href")}}),contents:{coverages:m(k(a,"http://www.opengis.net/wcs/2.0","CoverageSummary"),function(a){return{coverageId:e(a,"http://www.opengis.net/wcs/2.0","CoverageId"),
coverageSubtype:e(a,"http://www.opengis.net/wcs/2.0","CoverageSubtype")}})}}},ExceptionReport:function(a){a=f(a,"http://www.opengis.net/ows/2.0","Exception");a={code:a.getAttribute("exceptionCode"),locator:a.getAttribute("locator"),text:e(a,"http://www.opengis.net/ows/2.0","ExceptionText")};if(g.throwOnException)throw new Exception(a.text);return a},CoverageDescriptions:function(a){return{coverageDescriptions:m(k(a,"http://www.opengis.net/wcs/2.0","CoverageDescription"),function(a){return WCS.Core.Parse.callParseFunctions(a.localName,
a)})}},CoverageDescription:p,RectifiedGridCoverage:p});return{pushParseFunction:a,pushParseFunctions:d,parse:function(a){a="string"===typeof a?c(a).documentElement:a.documentElement;return WCS.Core.Parse.callParseFunctions(a.localName,a)},callParseFunctions:function(a,c){if(b.hasOwnProperty(a)){for(var g=b[a],f={},d=0;d<g.length;++d){var e=g[d](c);WCS.Util.deepMerge(f,e)}return f}throw Error("No parsing function for tag name '"+a+"' registered.");},options:g}}();namespace("WCS.EO");
WCS.EO.KVP=function(){return{describeEOCoverageSetURL:function(c,b,a,d){if(!c||!b)throw Error("Parameters 'url' and 'eoid' are mandatory.");a=a||{};d=d||{};subsetCRS=a.subsetCRS||"http://www.opengis.net/def/crs/EPSG/0/4326";b=["service=wcs","version=2.0.0","request=describeeocoverageset","eoid="+b];a.bbox&&(!a.subsetX&&!a.subsetY)&&(a.subsetX=[a.bbox[0],a.bbox[2]],a.subsetY=[a.bbox[1],a.bbox[3]]);a.subsetX&&b.push("subset=x,"+subsetCRS+"("+a.subsetX[0]+","+a.subsetX[1]+")");a.subsetY&&b.push("subset=y,"+
subsetCRS+"("+a.subsetY[0]+","+a.subsetY[1]+")");a.subsetTime&&b.push('subset=phenomenonTime("'+a.subsetTime[0]+'","'+a.subsetTime[1]+'")');a.containment&&b.push("containment="+a.containment);a.count&&b.push("count="+a.count);a.sections&&b.push("sections="+a.sections.join(","));a=WCS.Util.objectToKVP(d);return c+("?"!==c.charAt(c.length-1)?"?":"")+b.join("&")+(0<a.length?"&"+a:"")}}}();
WCS.EO.Parse=function(){var c=WCS.Util.getFirst,b=WCS.Util.getText,a=WCS.Util.getAll,d=WCS.Util.map;return{parseEOCoverageSetDescription:function(a){var b=c(a,"http://www.opengis.net/wcs/2.0","CoverageDescriptions"),b=b?WCS.Core.Parse.callParseFunctions("CoverageDescriptions",b):[];a=(a=c(a,"http://www.opengis.net/wcseo/1.0","DatasetSeriesDescriptions"))?WCS.Core.Parse.callParseFunctions("DatasetSeriesDescriptions",a):[];return{coverageDescriptions:b.coverageDescriptions,datasetSeriesDescriptions:a.datasetSeriesDescriptions}},
parseDatasetSeriesDescriptions:function(b){return{datasetSeriesDescriptions:d(a(b,"http://www.opengis.net/wcseo/1.0","DatasetSeriesDescription"),function(a){return WCS.Core.Parse.callParseFunctions("DatasetSeriesDescription",a)})}},parseDatasetSeriesDescription:function(){return{}},parseExtendedCapabilities:function(c){return{contents:{datasetSeries:d(a(c,"http://www.opengis.net/wcseo/1.0","DatasetSeriesSummary"),function(a){return{datasetSeriesId:b(a,"http://www.opengis.net/wcseo/1.0","DatasetSeriesId"),
timePeriod:[new Date(b(a,"http://www.opengis.net/gml/3.2","beginPosition")),new Date(b(a,"http://www.opengis.net/gml/3.2","endPosition"))]}})}}},parseExtendedCoverageDescription:function(a){var d=c(a,"http://www.opengis.net/wcseo/1.0","EOMetadata");return d?(a=c(d,"http://www.opengis.net/om/2.0","phenomenonTime"),d=c(d,"http://www.opengis.net/om/2.0","featureOfInterest"),{footprint:WCS.Util.stringToFloatArray(b(d,"http://www.opengis.net/gml/3.2","posList")),timePeriod:[new Date(b(a,"http://www.opengis.net/gml/3.2",
"beginPosition")),new Date(b(a,"http://www.opengis.net/gml/3.2","endPosition"))]}):{}}}}();WCS.Core.Parse.pushParseFunctions({EOCoverageSetDescription:WCS.EO.Parse.parseEOCoverageSetDescription,DatasetSeriesDescriptions:WCS.EO.Parse.parseDatasetSeriesDescriptions,DatasetSeriesDescription:WCS.EO.Parse.parseDatasetSeriesDescription,Capabilities:WCS.EO.Parse.parseExtendedCapabilities,CoverageDescription:WCS.EO.Parse.parseExtendedCoverageDescription});namespace("WCS.Backbone").Model=function(){var c=function(a,b){return!a||!a[b]?null:_.isFunction(a[b])?a[b]():a[b]},b=Backbone.Model.extend({initialize:function(a){a.urlRoot&&(this.urlRoot=a.urlRoot,delete a.urlRoot)},fetch:function(a){a||(a={});a.dataType="xml";Backbone.Model.prototype.fetch.call(this,a)}}),a=Backbone.Collection.extend({fetch:function(a){a||(a={});a.dataType="xml";Backbone.Collection.prototype.fetch.call(this,a)}}),d={};d.Service=b.extend({url:function(){return WCS.Core.KVP.getCapabilitiesURL(c(this,
"urlRoot"))},parse:function(a){return WCS.Core.Parse.parse(a)},fetchAdvertisedCoverages:function(a){var b=this.get("contents"),c=[];b&&(c=_.pluck(b.coverages,"coverageId"));b=new CoverageSet([],{urlRoot:this.urlRoot,coverageIds:c});b.fetch(a);return b}});d.Coverage=b.extend({idAttribute:"coverageId",url:function(){var a=c(this,"urlRoot")||c(this.collection,"url");if(this.id)return WCS.Core.KVP.describeCoverageURL(a,this.id)},parse:function(a){return _.has(a,"coverageId")?a:WCS.Core.Parse.parse(a).coverageDescriptions[0]},
getRangeType:function(){return this.get("rangeType")},getDownloadUrl:function(a){var b=c(this,"urlRoot")||c(this.collection,"urlRoot");return WCS.Core.KVP.getCoverageURL(b,this.id,a)}});d.CoverageSet=a.extend({model:d.Coverage,initialize:function(a,b){this._ids=0==a.length?b.coverageIds||[]:_.pluck(a,id);this.urlRoot=b.urlRoot||this.urlRoot},url:function(){return WCS.Core.KVP.describeCoverageURL(this.urlRoot,this._ids)},parse:function(a){return WCS.Core.Parse.parse(a).coverageDescriptions}});namespace("WCS").EO&&
(d.EOCoverageSet=a.extend({initialize:function(a,b){this.options=b||{};if(this.type=b.type||this.type)delete b.type,"coverages"===this.type?this.model=d.Coverage:"datasetSeries"===this.type&&(this.model=d.DatasetSeries);this.urlRoot=b.urlRoot||this.urlRoot;this.eoid=b.eoid||this.eoid},url:function(){return WCS.EO.KVP.describeEOCoverageSetURL(this.urlRoot,this.eoid,this.options)},parse:function(a){a=WCS.Core.Parse.parse(a);this.coverageDescriptions=a.coverageDescriptions;this.datasetSeriesDescriptions=
a.datasetSeriesDescriptions;switch(this.type){case "coverages":return a.coverageDescriptions;case "datasetSeries":return a.datasetSeriesDescriptions;default:return _.union(a.coverageDescriptions,a.datasetSeriesDescriptions)}}}));return d}();
